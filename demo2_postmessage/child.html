<!DOCTYPE html>
<!--
==============================================================================
POSTMESSAGE DEMO - CHILD WINDOW (child.html)
==============================================================================

WHAT IS THIS?
-------------
This represents the "embedded content" in a cross-domain communication scenario.
It's loaded inside an iframe in parent.html.

In the SCORM context, this is like your external course content that:
  - Needs to tell the LMS when the learner completes
  - Sends messages to the parent SCORM wrapper
  - Waits for acknowledgments
  - Handles beforeunload to save progress

KEY CONCEPTS DEMONSTRATED:
--------------------------
1. Sending messages to parent window
2. Listening for acknowledgments
3. beforeunload handling
4. Message structure best practices
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>postMessage Demo - Child Window</title>
  <style>
    /**
     * CHILD WINDOW STYLES
     * ===================
     * Keeping styles inline since this is loaded in an iframe
     * and we want it to be self-contained.
     */
    
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 15px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    
    .child-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      margin: 0 0 5px 0;
      font-size: 1.2rem;
      color: #333;
    }
    
    .subtitle {
      color: #666;
      margin: 0 0 20px 0;
      font-size: 0.85rem;
    }
    
    /* Message type buttons */
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .msg-btn {
      padding: 12px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: transform 0.1s, box-shadow 0.1s;
      text-align: left;
    }
    
    .msg-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .msg-btn:active {
      transform: translateY(0);
    }
    
    .btn-ping {
      background: #e3f2fd;
      color: #1565c0;
    }
    
    .btn-greeting {
      background: #e8f5e9;
      color: #2e7d32;
    }
    
    .btn-complete {
      background: #fff3e0;
      color: #e65100;
    }
    
    .btn-custom {
      background: #f3e5f5;
      color: #7b1fa2;
    }
    
    /* Custom message input */
    .custom-section {
      margin-bottom: 20px;
    }
    
    .custom-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    
    /* Log area */
    .log-area {
      background: #263238;
      border-radius: 6px;
      padding: 15px;
      color: #fff;
      font-family: Monaco, Consolas, monospace;
      font-size: 0.8rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .log-area h3 {
      margin: 0 0 10px 0;
      color: #80cbc4;
      font-size: 0.85rem;
    }
    
    .log-entry {
      margin: 5px 0;
      padding: 5px 10px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
    }
    
    .log-sent {
      border-left: 3px solid #4caf50;
    }
    
    .log-received {
      border-left: 3px solid #2196f3;
    }
    
    .log-error {
      border-left: 3px solid #f44336;
    }
    
    /* Status display */
    .status-bar {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #666;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }
    
    .counter {
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="child-container">
    
    <h1>üì± Child Window (iframe)</h1>
    <p class="subtitle">I'm embedded content that sends messages to my parent</p>
    
    <!-- Predefined message buttons -->
    <div class="button-group">
      <button class="msg-btn btn-ping" onclick="sendPing()">
        üèì Send Ping
        <small style="display:block;font-weight:normal;margin-top:3px">
          Test if parent is listening
        </small>
      </button>
      
      <button class="msg-btn btn-greeting" onclick="sendGreeting()">
        üëã Send Greeting
        <small style="display:block;font-weight:normal;margin-top:3px">
          Send a friendly hello message
        </small>
      </button>
      
      <button class="msg-btn btn-complete" onclick="sendComplete()">
        ‚úÖ Send Completion
        <small style="display:block;font-weight:normal;margin-top:3px">
          Like marking a course complete
        </small>
      </button>
    </div>
    
    <!-- Custom message -->
    <div class="custom-section">
      <input type="text" class="custom-input" id="custom-msg" 
             placeholder="Type a custom message...">
      <button class="msg-btn btn-custom" onclick="sendCustom()" style="width:100%">
        üìù Send Custom Message
      </button>
    </div>
    
    <!-- Message log -->
    <div class="log-area">
      <h3>üì¨ Message Log</h3>
      <div id="child-log">
        <div class="log-entry">Waiting for activity...</div>
      </div>
    </div>
    
    <!-- Status bar -->
    <div class="status-bar">
      <span>Sent: <span class="counter" id="sent-count">0</span></span>
      <span>Acks: <span class="counter" id="ack-count">0</span></span>
      <span>Received: <span class="counter" id="recv-count">0</span></span>
    </div>
    
  </div>
  
  <script>
    /**
     * ===========================================================================
     * CHILD WINDOW POSTMESSAGE SENDER
     * ===========================================================================
     * 
     * This script demonstrates the SENDING side of postMessage communication.
     * Key responsibilities:
     *   1. Send structured messages to the parent window
     *   2. Listen for acknowledgments
     *   3. Handle beforeunload events
     */
    
    /* =========================================================================
     * MESSAGE COUNTERS
     * ========================================================================= */
    
    let sentCount = 0;
    let ackCount = 0;
    let recvCount = 0;
    
    function updateCounters() {
      document.getElementById('sent-count').textContent = sentCount;
      document.getElementById('ack-count').textContent = ackCount;
      document.getElementById('recv-count').textContent = recvCount;
    }
    
    /* =========================================================================
     * CORE SEND FUNCTION
     * ========================================================================= */
    
    /**
     * SEND MESSAGE TO PARENT
     * ======================
     * This is the fundamental operation: sending data to the parent window.
     * 
     * HOW IT WORKS:
     * - window.parent refers to the window that contains this iframe
     * - postMessage(data, targetOrigin) sends the data
     * - targetOrigin specifies who can receive it ('*' = anyone)
     * 
     * @param {Object} data - The message data to send
     */
    function sendToParent(data) {
      // First, check if we're actually in an iframe
      if (window.parent === window) {
        console.warn('‚ö†Ô∏è Not in an iframe - no parent to send to!');
        logEntry('error', 'Not in iframe - cannot send');
        return false;
      }
      
      // Add metadata to the message
      const messageWithMeta = {
        ...data,
        sentAt: new Date().toISOString(),
        // Include sender info (helps parent identify source)
        sender: 'child-demo'
      };
      
      console.log('üì§ Sending to parent:', messageWithMeta);
      
      // THE KEY LINE: Send the message!
      // Using '*' as target origin for demo purposes
      // In production, you might want to be more specific
      window.parent.postMessage(messageWithMeta, '*');
      
      sentCount++;
      updateCounters();
      logEntry('sent', `Sent: ${data.type}`);
      
      return true;
    }
    
    /* =========================================================================
     * PREDEFINED MESSAGE TYPES
     * ========================================================================= */
    
    /**
     * PING MESSAGE
     * ============
     * A simple "are you there?" message to test connectivity.
     * Useful to verify communication is working before sending important data.
     */
    function sendPing() {
      sendToParent({
        type: 'ping',
        message: 'Hello, are you listening?'
      });
    }
    
    /**
     * GREETING MESSAGE
     * ================
     * Example of a simple data message.
     */
    function sendGreeting() {
      sendToParent({
        type: 'greeting',
        message: 'Hello from the child iframe!',
        emoji: 'üëã'
      });
    }
    
    /**
     * COMPLETION MESSAGE
     * ==================
     * This is what you'd use in SCORM to signal course completion.
     * The parent (SCORM wrapper) would receive this and call the LMS API.
     */
    function sendComplete() {
      sendToParent({
        type: 'complete',
        status: 'completed',
        message: 'User has completed the content!'
      });
    }
    
    /**
     * CUSTOM MESSAGE
     * ==============
     * Send whatever the user types.
     */
    function sendCustom() {
      const input = document.getElementById('custom-msg');
      const message = input.value.trim();
      
      if (!message) {
        alert('Please enter a message');
        return;
      }
      
      sendToParent({
        type: 'custom',
        message: message
      });
      
      input.value = '';
    }
    
    /* =========================================================================
     * LISTENING FOR RESPONSES
     * ========================================================================= */
    
    /**
     * MESSAGE LISTENER
     * ================
     * Listen for messages from the parent window.
     * This receives:
     *   - Acknowledgments for messages we sent
     *   - Commands/data from the parent
     */
    window.addEventListener('message', function(event) {
      console.log('üì• Child received message:');
      console.log('  Origin:', event.origin);
      console.log('  Data:', event.data);
      
      const data = event.data;
      
      // Check if it's an acknowledgment
      if (data && data.type === 'ack') {
        ackCount++;
        updateCounters();
        logEntry('received', `‚úÖ ACK: ${data.originalType || 'message'} received`);
        return;
      }
      
      // It's a regular message from parent
      recvCount++;
      updateCounters();
      logEntry('received', `üì© From parent: ${data.message || JSON.stringify(data)}`);
    });
    
    /* =========================================================================
     * BEFOREUNLOAD HANDLING
     * ========================================================================= */
    
    /**
     * BEFOREUNLOAD EVENT
     * ==================
     * This fires when the user is about to leave the page (close tab, navigate
     * away, refresh, etc.).
     * 
     * IMPORTANT LIMITATIONS:
     * - You have VERY limited time to do anything
     * - Async operations may not complete
     * - postMessage MAY or MAY NOT be delivered
     * - Modern browsers limit what you can do here
     * 
     * USE WITH CAUTION:
     * - Only for "best effort" saving
     * - Don't rely on this for critical data
     * - Always have explicit save buttons for important data
     */
    window.addEventListener('beforeunload', function(event) {
      console.log('üëã Child window is closing!');
      
      // Try to send a final message
      // Note: This may not be delivered!
      sendToParent({
        type: 'beforeunload',
        message: 'Child window is closing',
        // You might include progress data here
        lastActivity: new Date().toISOString()
      });
      
      logEntry('sent', 'üëã Sent beforeunload notification');
      
      // Note: Modern browsers ignore custom messages in beforeunload
      // The return value doesn't control what's shown anymore
    });
    
    /* =========================================================================
     * UI LOGGING
     * ========================================================================= */
    
    /**
     * ADD LOG ENTRY
     * =============
     * Visual logging in the UI for demo purposes.
     */
    function logEntry(type, message) {
      const log = document.getElementById('child-log');
      
      // Clear placeholder on first entry
      if (log.children.length === 1 && 
          log.firstChild.textContent.includes('Waiting')) {
        log.innerHTML = '';
      }
      
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      
      log.insertBefore(entry, log.firstChild);
      
      // Keep only last 8 entries
      while (log.children.length > 8) {
        log.removeChild(log.lastChild);
      }
    }
    
    // Allow Enter key to send custom message
    document.getElementById('custom-msg').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') sendCustom();
    });
    
    // Announce loading
    console.log('üì± Child window loaded and ready!');
    
    // Send initial ping after a short delay (let parent set up first)
    setTimeout(function() {
      console.log('üèì Sending initial ping to parent...');
      sendPing();
    }, 500);
  </script>
</body>
</html>
